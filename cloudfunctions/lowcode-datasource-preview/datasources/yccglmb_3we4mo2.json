{
	"configuration":{
		"vars":{
			"type":"object",
			"value":{
				"TARGET_ENV":"cloud1-5g3rtj7qe52f5db7"
			},
			"key":"9ed711a5dfd52d32"
		}
	},
	"desc":"",
	"id":"data-5ce7rDk9G",
	"isNewDataSource":1,
	"methods":[
		{
			"inParams":{
				"additionalProperties":true,
				"type":"object",
				"properties":{
					"filterPath":{
						"x-required":false,
						"x-keyPath":"",
						"x-id":"9678cc2",
						"format":"",
						"description":"",
						"type":"string",
						"x-index":6,
						"title":"filterPath",
						"x-unique":false,
						"maxLength":4000
					},
					"pageNo":{
						"x-required":false,
						"x-keyPath":"",
						"x-id":"9bea6f5",
						"format":"",
						"name":"pageNo",
						"description":"",
						"type":"number",
						"x-index":2,
						"title":"pageNo",
						"x-unique":false
					},
					"pageSize":{
						"x-required":false,
						"x-keyPath":"",
						"x-id":"ae9faef",
						"format":"",
						"name":"pageSize",
						"description":"",
						"type":"number",
						"x-index":4,
						"title":"pageSize",
						"x-unique":false
					}
				},
				"required":[]
			},
			"isTitleInValid":false,
			"name":"method_717c84c1e1f75",
			"title":"查询文件列表",
			"type":"cloud-function",
			"outParams":{
				"x-keyPath":"",
				"x-id":"oloeg718",
				"title":"value",
				"type":"object",
				"properties":{
					"total":{
						"x-keyPath":"total",
						"x-id":"ya9xet1u",
						"title":"total",
						"type":"number"
					},
					"records":{
						"x-keyPath":"records",
						"x-id":"l4qtj87p",
						"title":"records",
						"type":"array",
						"items":{
							"x-keyPath":"",
							"x-id":"1cb4gb7i",
							"title":"value",
							"type":"object",
							"properties":{
								"LastModified":{
									"x-keyPath":"$item.LastModified",
									"x-id":"fac3ws9q",
									"title":"LastModified",
									"type":"string"
								},
								"Owner":{
									"x-keyPath":"",
									"x-id":"1lk2ycby",
									"title":"Owner",
									"type":"object",
									"properties":{
										"DisplayName":{
											"x-keyPath":"$item.Owner.DisplayName",
											"x-id":"hscx85q7",
											"title":"DisplayName",
											"type":"string"
										},
										"ID":{
											"x-keyPath":"$item.Owner.ID",
											"x-id":"k7cwfy6m",
											"title":"ID",
											"type":"string"
										}
									}
								},
								"ETag":{
									"x-keyPath":"$item.ETag",
									"x-id":"mkyzfwbi",
									"title":"ETag",
									"type":"string"
								},
								"Size":{
									"x-keyPath":"$item.Size",
									"x-id":"p3b7w7v8",
									"title":"Size",
									"type":"string"
								},
								"StorageClass":{
									"x-keyPath":"$item.StorageClass",
									"x-id":"zarv4uvo",
									"title":"StorageClass",
									"type":"string"
								},
								"Key":{
									"x-keyPath":"$item.Key",
									"x-id":"ovdqvki8",
									"title":"Key",
									"type":"string"
								},
								"Url":{
									"x-keyPath":"$item.Url",
									"x-id":"5c6atzq1",
									"title":"Url",
									"type":"string"
								}
							}
						}
					}
				}
			},
			"intent":"create",
			"calleeBody":{
				"callee":"'use strict';\n\nconst CloudBase = require('@cloudbase/manager-node')\n\nmodule.exports = async (event, context) => {\n    let { pageNo, pageSize, filterPath = '/' } = event\n\n    const app = CloudBase.init({\n        envId: context.vars.TARGET_ENV || context.env.envId // 云环境 ID，可在腾讯云-云开发控制台获取\n    })\n\n    // 获取各功能模块\n    const { database, functions, storage, env, commonService } = app\n\n    const res = await storage.listDirectoryFiles(filterPath)\n\n    const records = res.slice((pageNo - 1) * pageSize, pageNo * pageSize)\n    if (records.length === 0) {\n        return {\n            records: [],\n            total: 0\n        }\n    }\n    // 获取临时链接\n    const urls = await storage.getTemporaryUrl(records.map(item => item.Key))\n\n    records.forEach((item, index) => {\n        item.Url = urls[index].url\n    })\n\n    return {\n        records: records,\n        total: res.length\n    }\n};\n",
				"config":{
					"deps":{
						"":"cloudbase/manager-node"
					}
				}
			},
			"isCollapse":false,
			"uuid":"0e0a5669-e5ee-4fe5-8134-0c8f2b9306ca",
			"isShow":true
		},
		{
			"inParams":{
				"additionalProperties":true,
				"type":"object",
				"properties":{
					"key":{
						"x-required":false,
						"x-keyPath":"",
						"x-id":"9737758",
						"format":"",
						"description":"",
						"type":"string",
						"x-index":2,
						"title":"key",
						"x-unique":false,
						"maxLength":4000
					}
				},
				"required":[]
			},
			"isTitleInValid":false,
			"name":"method_489409cffda50",
			"title":"查询文件信息",
			"type":"cloud-function",
			"outParams":{
				"x-keyPath":"",
				"x-id":"3qfe8asd",
				"title":"value",
				"type":"object",
				"properties":{
					"Type":{
						"x-keyPath":"Type",
						"x-id":"cgi4xgkv",
						"title":"Type",
						"type":"string"
					},
					"ETag":{
						"x-keyPath":"ETag",
						"x-id":"f1zv1xie",
						"title":"ETag",
						"type":"string"
					},
					"Size":{
						"x-keyPath":"Size",
						"x-id":"y96tu76i",
						"title":"Size",
						"type":"string"
					},
					"Date":{
						"x-keyPath":"Date",
						"x-id":"6tkl2wpm",
						"title":"Date",
						"type":"string"
					}
				}
			},
			"intent":"create",
			"calleeBody":{
				"callee":"'use strict';\n\nconst CloudBase = require('@cloudbase/manager-node')\n\nmodule.exports = async (event, context) => {\n    let { key } = event\n\n    const app = CloudBase.init({\n        envId: context.vars.TARGET_ENV // 云环境 ID，可在腾讯云-云开发控制台获取\n    })\n\n    // 获取各功能模块\n    const { database, functions, storage, env, commonService } = app\n\n    const res = await storage.getFileInfo(key)\n\n    return res\n};\n",
				"config":{
					"deps":{
						"":"cloudbase/manager-node"
					}
				}
			},
			"isCollapse":true,
			"uuid":"bdbe21c0-aa68-466c-bad6-6206a6250601",
			"isShow":true
		},
		{
			"inParams":{
				"additionalProperties":true,
				"type":"object",
				"properties":{
					"targetPath":{
						"x-required":false,
						"x-keyPath":"",
						"x-id":"6cf4f3e",
						"format":"",
						"name":"targetPath",
						"description":"",
						"isEnum":false,
						"type":"string",
						"x-index":4,
						"title":"targetPath",
						"x-unique":false,
						"maxLength":4000
					},
					"cloudIdArray":{
						"x-required":false,
						"x-keyPath":"",
						"x-id":"9c8448b",
						"format":"",
						"name":"cloudIdArray",
						"description":"",
						"isEnum":false,
						"type":"array",
						"x-index":2,
						"title":"cloudIdArray",
						"items":{
							"format":"x-file",
							"type":"string"
						},
						"x-unique":false
					}
				},
				"required":[]
			},
			"isTitleInValid":false,
			"name":"method_5549f07cca959",
			"title":"上传文件",
			"type":"cloud-function",
			"outParams":{
				"x-keyPath":"",
				"x-id":"fzk8uzc2",
				"title":"value",
				"type":"object",
				"properties":{
					"code":{
						"x-keyPath":"code",
						"x-id":"fushxkwu",
						"title":"code",
						"type":"string"
					}
				}
			},
			"intent":"create",
			"calleeBody":{
				"callee":"'use strict';\n\nconst CloudBase = require('@cloudbase/manager-node')\nconst fetch = require('node-fetch')\nconst nodeSDK = require('@cloudbase/node-sdk')\nconst fs = require('fs');\nconst path = require('path')\nconst url = require('url')\n\nconst TMP_DIR = '/tmp/images/' + new Date().getTime()\n\nasync function downloadFile(url, targetPath) {\n  const dir = path.dirname(targetPath)\n  if (!fs.existsSync(dir)) {\n      fs.mkdirSync(dir, { recursive: true })\n  }\n  const res = await fetch(url);\n  const fileStream = fs.createWriteStream(targetPath);\n  return new Promise((resolve, reject) => {\n    res.body.pipe(fileStream);\n    res.body.on(\"error\", reject);\n    fileStream.on(\"finish\", resolve);\n  });\n};\n\nmodule.exports = async (event, context) => {\n    const { cloudIdArray, targetPath } = event\n\n    console.log(cloudIdArray, targetPath)\n\n    const admin = nodeSDK.init({\n        env: context.envInfo.envId\n    })\n\n    const app = CloudBase.init({\n        envId: context.vars.TARGET_ENV\n    })\n\n    const { database, functions, storage, env, commonService } = app\n\n    const res = await admin.getTempFileURL({ fileList: cloudIdArray })\n\n    const fileList = res.fileList\n\n    await Promise.all(fileList.map(file => downloadFile(file.tempFileURL, `${TMP_DIR}/${getFileName(file.tempFileURL)}`)))\n\n    // 下载文件\n    console.log(await fs.promises.readdir(TMP_DIR))\n\n    console.log(TMP_DIR, targetPath)\n    await storage.uploadDirectory({\n        localPath: path.resolve(TMP_DIR),\n        cloudPath: targetPath\n    })\n\n    return {\n        code: 'success'\n    }\n};\n\n\nfunction getFileName(link) {\n    return url.parse(link).pathname.split('/').pop()\n}\n",
				"config":{
					"deps":{
						"":"cloudbase/node-sdk",
						"path":"*",
						"node-fetch":"*",
						"fs":"*",
						"url":"*"
					}
				}
			},
			"isCollapse":true,
			"uuid":"5666ef67-a2a1-4934-a5ff-122e1ee0e664",
			"isShow":true
		},
		{
			"inParams":{
				"additionalProperties":true,
				"type":"object",
				"properties":{
					"path":{
						"x-required":true,
						"x-keyPath":"",
						"x-id":"966bfdd",
						"format":"",
						"description":"",
						"type":"string",
						"x-index":2,
						"title":"path",
						"x-unique":false,
						"maxLength":4000
					}
				},
				"required":[]
			},
			"isTitleInValid":false,
			"name":"method_4d4befefc6906",
			"title":"删除文件或文件夹",
			"type":"cloud-function",
			"outParams":{
				"x-keyPath":"",
				"x-id":"nfhs4znt",
				"title":"value",
				"type":"object",
				"properties":{
					"code":{
						"x-keyPath":"code",
						"x-id":"e5ai4vzj",
						"title":"code",
						"type":"string"
					}
				}
			},
			"intent":"create",
			"calleeBody":{
				"callee":"'use strict';\n\nconst CloudBase = require('@cloudbase/manager-node')\n\nmodule.exports = async (event, context) => {\n    const { path } = event\n\n    const app = CloudBase.init({\n        envId: context.vars.TARGET_ENV // 云环境 ID，可在腾讯云-云开发控制台获取\n    })\n\n    // 获取各功能模块\n    const { database, functions, storage, env, commonService } = app\n\n    if (path.endsWith('/')){\n        await storage.deleteDirectory(path)\n    } else {\n        await storage.deleteFile([path])\n    }\n\n    return {\n        code: 'success'\n    }\n};\n",
				"config":{
					"deps":{
						"":"cloudbase/manager-node"
					}
				}
			},
			"isCollapse":true,
			"uuid":"0a9a6f3a-6bbe-4249-850e-6b90d69a68e5",
			"isShow":true
		},
		{
			"inParams":{
				"additionalProperties":true,
				"type":"object",
				"properties":{
					"dirname":{
						"x-required":true,
						"x-keyPath":"",
						"x-id":"85b0d43",
						"format":"",
						"description":"",
						"type":"string",
						"x-index":2,
						"title":"dirname",
						"x-unique":false,
						"maxLength":4000
					}
				},
				"required":[]
			},
			"isTitleInValid":false,
			"name":"method_61e49339cbbd8",
			"title":"新建文件夹",
			"type":"cloud-function",
			"outParams":{
				"x-keyPath":"",
				"x-id":"6xlpcd56",
				"title":"value",
				"type":"object",
				"properties":{
					"code":{
						"x-keyPath":"code",
						"x-id":"vttea8m4",
						"title":"code",
						"type":"string"
					}
				}
			},
			"intent":"create",
			"calleeBody":{
				"callee":"'use strict';\n\nconst CloudBase = require('@cloudbase/manager-node')\nconst path = require('path')\nconst fs = require('fs')\n\nmodule.exports = async (event, context) => {\n    const { dirname } = event\n\n    const app = CloudBase.init({\n        envId: context.vars.TARGET_ENV // 云环境 ID，可在腾讯云-云开发控制台获取\n    })\n\n    // 获取各功能模块\n    const { database, functions, storage, env, commonService } = app\n\n    const emptyDirName = path.dirname(dirname)\n    fs.mkdirSync(emptyDirName, { recursive: true })\n\n    storage.uploadDirectory({\n      localPath: emptyDirName,\n      cloudPath: path.parse(dirname).dir,\n    })\n\n    return {\n        code: 'success'\n    }\n};\n",
				"config":{
					"deps":{
						"":"cloudbase/manager-node",
						"path":"*",
						"fs":"*"
					}
				}
			},
			"isCollapse":true,
			"uuid":"46582d7a-99ce-4e28-b93d-ba1632457c55",
			"isShow":true
		}
	],
	"name":"yccglmb_3we4mo2",
	"pkgId":"cloud1-5g3rtj7qe52f5db7",
	"templateCode":"empty",
	"title":"云存储管理面板",
	"type":"cloud-integration"
}